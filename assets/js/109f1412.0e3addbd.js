"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[559],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var o=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},i=Object.keys(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=o.createContext({}),c=function(e){var t=o.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},p=function(e){var t=c(e.components);return o.createElement(l.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},d=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=c(n),d=r,h=u["".concat(l,".").concat(d)]||u[d]||m[d]||i;return n?o.createElement(h,a(a({ref:t},p),{},{components:n})):o.createElement(h,a({ref:t},p))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,a=new Array(i);a[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[u]="string"==typeof e?e:r,a[1]=s;for(var c=2;c<i;c++)a[c]=n[c];return o.createElement.apply(null,a)}return o.createElement.apply(null,n)}d.displayName="MDXCreateElement"},6585:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>m,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var o=n(7462),r=(n(7294),n(3905));const i={sidebar_position:3},a="Motivation",s={unversionedId:"motivation",id:"motivation",title:"Motivation",description:"Some things are difficult to mock. This difficulty often arises due to poor design on our part, but there are also cases where we have limited control over it, such as with frameworks or other third-party library APIs. So, how is such code tested?",source:"@site/docs/motivation.md",sourceDirName:".",slug:"/motivation",permalink:"/mlok/docs/motivation",draft:!1,tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"Getting started",permalink:"/mlok/docs/getting-started"},next:{title:"Tutorial - Basics",permalink:"/mlok/docs/category/tutorial---basics"}},l={},c=[{value:"Example",id:"example",level:3},{value:"Jest",id:"jest",level:4},{value:"Jest with Mlok",id:"jest-with-mlok",level:4}],p={toc:c},u="wrapper";function m(e){let{components:t,...n}=e;return(0,r.kt)(u,(0,o.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"motivation"},"Motivation"),(0,r.kt)("p",null,"Some things are difficult to mock. This difficulty often arises due to poor design on our part, but there are also cases where we have limited control over it, such as with frameworks or other third-party library APIs. So, how is such code tested?"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"It's not")," Often a pragmatic solution, ideally applied only to the residue of code that is no longer logically reducable or splittable."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Uses real thing in an integration test")," This approach works well in certain situations, such as when running tests against a dockerized database or a sandboxed service environment. However, it's not always available or efficient and test performance becomes an issue when overused."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Write a complex mock and a unit test")," Requires lot of effort and resulting mocks are usually highly coupled with the implementation.")),(0,r.kt)("p",null,'While unit tests are not the only type of testing to do, it should be the easiest. Mlok enables you to write mocks for complex inputs (like Request object, database connection, SDK instance) with the same ease as passing in a number or string. Stop worrying about creating mocks that "don\'t crash", focus on the behavior specific to your tests. Stop saying ',(0,r.kt)("em",{parentName:"p"},"something is not tested, because...")),(0,r.kt)("h3",{id:"example"},"Example"),(0,r.kt)("p",null,"In the simple snippet an ",(0,r.kt)("inlineCode",{parentName:"p"},"AuthenticationService")," gets a ",(0,r.kt)("inlineCode",{parentName:"p"},"UserRepository")," injected. Then it is able to provide a ",(0,r.kt)("inlineCode",{parentName:"p"},"User")," from the repository based on the bearer token provided from the HTTP request from the Nest.js-like context."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"export class AuthenticationService {\n  constructor(private readonly userRepository: UserRepository) {}\n\n  public async authenticate(ctx: ExecutionContext): Promise<User | null> {\n    const token = this.extractJWT(ctx)\n    if (!token) {\n      return null\n    }\n    return this.userRepository.getUserByToken(token)\n  }\n\n  private extractJWT(ctx: ExecutionContext): string | null {\n    const [, token] =\n      ctx\n        .switchToHttp()\n        .getRequest()\n        .headers.authorization?.toString()\n        ?.match(/bearer (.*)/i) ?? []\n    return token ?? null\n  }\n}\n")),(0,r.kt)("p",null,"Let's write a small test: ",(0,r.kt)("em",{parentName:"p"},"When request sends bearer token foo, user is retrieved by the token.")," It does not test all the logic, but it focuses on the token extraction and communication with the repository. Let's implement the tests in Jest."),(0,r.kt)("h4",{id:"jest"},"Jest"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"it('Jest', async () => {\n  const ctx: ExecutionContext = {\n    switchToHttp: () => ({\n      getRequest: () =>\n        ({ headers: { authorization: 'Bearer foo' } } as IncomingMessage),\n    }),\n  }\n  const userRepository: UserRepository = {\n    getUserById: jest.fn<any>(),\n    getUserByToken: jest.fn<any>(),\n  }\n  await new AuthenticationService(userRepository).authenticate(ctx)\n  expect(userRepository.getUserByToken).toHaveBeenCalledWith('foo')\n})\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},'\ud83d\udc94 Lot of explicit code needs to be implemented "not to crash" (',(0,r.kt)("inlineCode",{parentName:"p"},"ctx")," needs to return object with callable ",(0,r.kt)("inlineCode",{parentName:"p"},"switchToHttp"),", needs to return object with callable ",(0,r.kt)("inlineCode",{parentName:"p"},"getRequest"),", which needs to have property ",(0,r.kt)("inlineCode",{parentName:"p"},"headers"),").")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\ud83d\ude48 For rich interfaces, we need to either cast type (",(0,r.kt)("inlineCode",{parentName:"p"},"as IncomingMessage"),") or implement the whole behavior (",(0,r.kt)("inlineCode",{parentName:"p"},"UserRepository"),")."))),(0,r.kt)("h4",{id:"jest-with-mlok"},"Jest with Mlok"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"it('Mlok', async () => {\n  const userRepository = mlok<UserRepository>()\n  const ctx = mlok<ExecutionContext>().override({ authorization: 'Bearer foo' })\n  await new AuthenticationService(userRepository).authenticate(ctx)\n  expect(userRepository.getUserByToken).toHaveBeenCalledWith('foo')\n})\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\ud83d\udc9a Mock does not fail on default, all you need is ",(0,r.kt)("inlineCode",{parentName:"li"},"mlok<T>()"),", no need to implement whole interface nor type cast"),(0,r.kt)("li",{parentName:"ul"},"\u2705 Focus on what you need to test")))}m.isMDXComponent=!0}}]);